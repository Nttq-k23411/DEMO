<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xưởng Sáng Tạo - Gốm Thanh An</title>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

</head>
<body>

    <header class="container">
        <a href="home.html" class="logo">Gốm Thanh An</a> 
        <nav>
            <a href="home.html">Trang chủ</a>
            <a href="#">Sản Phẩm</a>
            <a href="#">Câu Chuyện</a>
            <a href="#">Liên Hệ</a>
        </nav>
        <div class="header-icons">
            <i data-lucide="search"></i>
            <i data-lucide="user"></i>
            <i data-lucide="heart"></i>
            <a href="cart.html" class="cart-link active">
                <i data-lucide="shopping-cart"></i>
                <span id="cart-badge" class="cart-count" style="display:none">0</span>
            </a>
        </div>
    </header>

    <main>
        <div class="container studio-container">

            <div class="studio-preview">
                <h3>Xưởng Sáng Tạo AI</h3>
                
                <div class="main-preview-area">
                    <div id="image-result">
                        <img src="../images/coc_tron.jpg" alt="Thiết kế gốm sứ của bạn" data-shape="coc-su">
                    </div>
                    
                    <div class="inspiration-gallery">
                        <h4>Thư Viện <br> Cảm Hứng</h4>
                        <div>
                        <div class="inspiration-grid">
                            <div class="inspiration-item">
                                <img src="../images/HASAMI.jpg" alt="Mẫu 1">
                            </div>
                            <div class="inspiration-item">
                                <img src="../images/ly 1.png" alt="Mẫu 2">
                            </div>
                            <div class="inspiration-item">
                                <img src="../images/Generated Image October 19, 2025 - 10_56PM.png" alt="Mẫu 3">
                            </div>
                            <div class="inspiration-item">
                                <img src="../images/lyy.jpg" alt="Mẫu 4">
                            </div>
                        </div>
                            <div class="inspiration-item inspiration-upload-btn" id="upload-inspiration-btn" title="Tải ảnh lên">
                                <i data-lucide="upload-cloud"></i>
                            </div>
                        </div>
                    </div>
                </div> 
            </div> <div class="studio-controls">
                <div class="studio-controls-header">
                    <h4>Bảng điều khiển</h4>
                    <div class="icons">
                        <i data-lucide="undo-2"></i>
                        <i data-lucide="bookmark"></i>
                    </div>
                </div>

                <div class="control-section">
                    <label for="select-product-shape">1. Chọn Hình Dáng</label>
                    <select id="select-product-shape" class="studio-select">
                        <option value="coc-su" selected>Cốc</option>
                        <option value="binh-hoa">Bình Hoa</option>
                        <option value="dia-su">Đĩa</option>
                    </select>
                </div>

                <div class="control-section">
                    <label for="prompt-input">2. Hộp Mô Tả (Prompt Box)</label>
                    <textarea id="prompt-input" rows="4" placeholder="Mô tả phong cách + họa tiết chính + màu sắc chủ đạo + cảm xúc hình ảnh."></textarea>
                </div>

                <div class="control-section">
                    <label>3. Công Cụ Tinh Chỉnh</label>
                    <div class="toggle-option">
                        <label for="toggle-abstract" style="color:black; font-weight: normal; font-size: 13px">Làm cho hoạ tiết trừu tượng hơn</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-abstract">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-option">
                        <label for="toggle-gold" style="color:black; font-weight: normal; font-size: 13px">Thêm chi tiết vàng kim</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-gold">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="control-section">
                    <label for="select-material">4. Chất liệu</label>
                    <select id="select-material" class="studio-select">
                        <option value="men-lam">Men lam</option>
                        <option value="men-ngoc">Men ngọc</option>
                        <option value="men-ran">Men rạn</option>
                        <option value="gom-tho">Gốm thô</option>
                    </select>
                </div>

                <div class="control-section">
                    <label for="select-signature">5. Thêm chữ/Ký Xứ</label>
                    <select id="select-signature" class="studio-select">
                        <option value="khong">Không thêm</option>
                        <option value="ky-niem-5-nam">Kỷ niệm 5 năm</option>
                        <option value="an-khang">An Khang Thịnh Vượng</option>
                        <option value="custom">Tùy chỉnh...</option>
                    </select>
                    <input type="text" id="custom-signature-input" placeholder="Nhập chữ của bạn..." style="display:none;">
                </div>

                <div class="studio-actions">
                    <button id="generate-btn">Tạo phác thảo</button>
                    <button id="confirm-btn" disabled>Thêm vào giỏ hàng</button>
                </div>

            </div>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <div class="footer-logo">Gốm Thanh An</div>
            <p>Nơi lưu giữ vẻ đẹp truyền thống trong từng tác phẩm gốm sứ.</p>
            <div class="footer-socials">
                <a href="#"><i data-lucide="facebook"></i></a>
                <a href="#"><i data-lucide="instagram"></i></a>
                <a href="#"><i data-lucide="youtube"></i></a>
            </div>
            <p style="margin-top: 20px; font-size: 14px; color: #aaa;">&copy; 2025 Gốm Thanh An. All Rights Reserved.</p>
        </div>
    </footer>
    <input type="file" id="inspiration-file-input" accept="image/*" style="display: none;">
<div id="toast-box"><i data-lucide="check-circle"></i> Đã thêm vào giỏ hàng thành công!</div>

<script>
    jQuery(document).ready(function($) {

    const WEBHOOK_URL_LUONG_1 = "https://quyenntt820.app.n8n.cloud/webhook/1d065385-3035-4a97-9f76-785676f9a761"; 

    const uploadBtn = $('#upload-inspiration-btn');
    const fileInput = $('#inspiration-file-input');
    const inspirationGrid = $('.inspiration-grid'); 
    const generateBtn = $('#generate-btn'); 
    const confirmBtn = $('#confirm-btn');   

    const baseProductImages = {
        'coc-su': '../images/coc_tron.jpg',
        'binh-hoa': '../images/binh_tron.jpg',
        'dia-su': '../images/dia_tron.jpg'
    };
    
    const inspirationImages = {
        'coc-su': ['../images/HASAMI.jpg', '../images/ly 1.png', '../images/Generated Image October 19, 2025 - 10_56PM.png', '../images/lyy.jpg'],
        'binh-hoa': ['../images/bình 1.jpg', '../images/binh_3.jpg', '../images/bình hoa.jpg', '../images/binh_4.jpg'],
        'dia-su': ['../images/đĩa xanh.jpg', '../images/dia_4.jpg', '../images/đĩa.jpg', '../images/đĩa hoa.jpg']
    };

    let finalImageUrl = '';
    let finalImageBlob = null; 
    let selectedInspirationUrl = ''; 
    let isRefining = false; 


function updateInspirationGallery(shape) {

    const images = inspirationImages[shape];
    let galleryHtml = '';

    if (images && images.length > 0) {
        images.forEach((imgUrl, index) => {
            galleryHtml += `<div class="inspiration-item"><img src="${imgUrl}" alt="Mẫu ${index}"></div>`;
        });
    }
    inspirationGrid.html(galleryHtml); 

}

    function attachInspirationClickEvent() {
        $('.inspiration-grid .inspiration-item img').off('click').on('click', function() {
            const newSrc = $(this).attr('src');
            $('#image-result img').attr('src', newSrc);
            selectedInspirationUrl = newSrc; 
            resetGenerationState();
        });
    }

    function resetGenerationState() {
        finalImageUrl = ''; 
        finalImageBlob = null;
        isRefining = false;
        generateBtn.text('Tạo phác thảo').prop('disabled', false);
        confirmBtn.prop('disabled', true).text('Thêm vào giỏ hàng'); 
    }

function getSignatureValue() {
    const selectedVal = $('#select-signature').val();

    if (selectedVal === 'custom') return $('#custom-signature-input').val();

    if (selectedVal === 'khong') return ''; 
    
    return selectedVal;
}

    $('#select-product-shape').on('change', function() {
        const selectedShape = $(this).val();
        $('#image-result img').attr('src', baseProductImages[selectedShape]);
        updateInspirationGallery(selectedShape);
        resetGenerationState(); 
    });

    uploadBtn.on('click', function() { fileInput.click(); });
    
    fileInput.on('change', function(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) { 
             const reader = new FileReader();
             reader.onload = function(e) {
                 const imageUrl = e.target.result; 
                 const newImageHtml = `<div class="inspiration-item"><img src="${imageUrl}" alt="Uploaded"></div>`; 
                 inspirationGrid.prepend(newImageHtml);
                 $('#image-result img').attr('src', imageUrl);
                 selectedInspirationUrl = imageUrl; 
                 resetGenerationState();
                 attachInspirationClickEvent();
             }
             reader.readAsDataURL(file); 
         }
         $(this).val('');
    });

    $('#select-signature').on('change', function() {
        if ($(this).val() === 'custom') $('#custom-signature-input').show();
        else $('#custom-signature-input').hide();
    });

    generateBtn.on('click', async function() {
        const prompt = $('#prompt-input').val();

        if (!prompt) { alert('Vui lòng nhập ý tưởng!'); return; }

        $(this).text('AI đang vẽ ...').prop('disabled', true);
        confirmBtn.prop('disabled', true);

        const inputData = {
            prompt: prompt,
            shape: $('#select-product-shape').val(),
            material: $('#select-material').val(),
            toggle_abstract: $('#toggle-abstract').is(':checked'),
            toggle_gold: $('#toggle-gold').is(':checked'),
            signature: getSignatureValue(),
            inspiration_image: selectedInspirationUrl 
        };

        console.log("Đang gọi Workflow 1...", inputData);

        try {
            const response = await fetch(WEBHOOK_URL_LUONG_1, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(inputData)
            });

            if (!response.ok) throw new Error('Lỗi kết nối');

            const imageBlob = await response.blob();

            finalImageUrl = URL.createObjectURL(imageBlob);
            finalImageBlob = imageBlob; 

            $('#image-result img').fadeOut(200, function() {
                $(this).attr('src', finalImageUrl).fadeIn(200);
            });

            $(this).text('Tinh chỉnh').prop('disabled', false);
            confirmBtn.prop('disabled', false).text('Thêm vào giỏ hàng');
            isRefining = true;

        } catch (error) {
            console.error('Lỗi tạo ảnh:', error);
            alert('AI đang bận, thử lại sau nhé! (Lỗi: ' + error.message + ')');
            $(this).text('Tạo phác thảo').prop('disabled', false);
        }
    });

    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('shoppingCart')) || [];
        const count = cart.length;
        const badge = $('#cart-badge'); 
        
        if(count > 0) {
            badge.text(count).show();
        } else {
            badge.hide();
        }
    }

    updateCartCount();

    function showToast() {
        const x = document.getElementById("toast-box");
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    confirmBtn.on('click', function() {
        if (!finalImageBlob) { alert("Chưa có ảnh!"); return; }

        const originalText = $(this).text();
        $(this).text('Đang lưu...').prop('disabled', true);

        const reader = new FileReader();
        reader.readAsDataURL(finalImageBlob); 
        
        reader.onloadend = function() {
            const base64data = reader.result;

            const cartItem = {
                id: 'SP-' + Date.now(),
                product_name: "Gốm sứ thiết kế AI - " + $('#select-product-shape').find(":selected").text(),
                shape: $('#select-product-shape').find(":selected").text(),
                material: $('#select-material').find(":selected").text(),
                preview_url: base64data,
                details: {
                    prompt: $('#prompt-input').val(),
                    gold: $('#toggle-gold').is(':checked'),
                    signature: getSignatureValue(),
                    inspiration_ref: selectedInspirationUrl
                },
                quantity: 1,
                price: 500000 
            };

            let cart = JSON.parse(localStorage.getItem('shoppingCart')) || [];
            cart.push(cartItem);
            
            try {
                localStorage.setItem('shoppingCart', JSON.stringify(cart));

                updateCartCount();
                showToast();
                $('#confirm-btn').text('Đã thêm ✔').prop('disabled', true);
                setTimeout(() => {
                    $('#confirm-btn').text('Thêm vào giỏ hàng'); 
                }, 2000);

            } catch (e) {
                alert("Lỗi bộ nhớ trình duyệt đầy. Vui lòng xóa bớt giỏ hàng.");
                $('#confirm-btn').text(originalText).prop('disabled', false);
            }
        }
    });
    lucide.createIcons();
    attachInspirationClickEvent();
});
</script>
</body>
</html>